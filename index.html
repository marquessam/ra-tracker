<!DOCTYPE html>
<html>
<head>
    <style>
        /* Existing styles remain the same */
        /* ... */

        /* Updated/new styles */
        .ra-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 30px;
        }
        .ra-logo {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }
        .ra-header-text {
            margin-left: 20px;
            flex-grow: 1;
        }
        .ra-challenge-title {
            color: #5c3391;
            font-size: 1.8em;
            margin: 0 0 15px 0;
        }
        .ra-game-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px 0;
            border-top: 2px solid #2a3a6a;
            border-bottom: 2px solid #2a3a6a;
        }
        .ra-game-link {
            color: inherit;
            text-decoration: none;
            display: inline-block;
            transition: opacity 0.2s;
        }
        .ra-game-link:hover {
            opacity: 0.8;
        }
        .ra-challenge-info {
            background: #2a3a6a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            line-height: 1.6;
            font-size: 0.9em;
        }
        /* Keep all other existing styles */
    </style>
</head>
<body>
    <div class="ra-widget">
        <div id="leaderboard"></div>
    </div>

    <script>
        // Keep existing constants and helper functions
        
        async function updateLeaderboardWithTimeout() {
            const timeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timed out')), TIMEOUT_DURATION)
            );

            try {
                document.getElementById('leaderboard').innerHTML = `
                    <div class="ra-loading">
                        <div class="ra-loading-spinner"></div>
                        <div>Loading leaderboard data...</div>
                        <div style="font-size: 0.8em; margin-top: 10px; color: #888;">
                            This may take a few moments as we fetch data for all players
                        </div>
                    </div>
                `;

                const fetchPromise = fetch(`/api/game-progress?gameId=${GAME_ID}`);
                const response = await Promise.race([fetchPromise, timeout]);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                let html = `
                    <div class="ra-header">
                        <img src="https://i.ibb.co/TgK5Hx9/select-start-logo-4.png" alt="Select Start" class="ra-logo">
                        <div class="ra-header-text">
                            <div class="ra-challenge-title">December Leaderboards</div>
                        </div>
                    </div>
                    <div class="ra-game-info">
                        <a href="https://retroachievements.org/game/3236" class="ra-game-link" target="_blank">
                            <img src="https://retroachievements.org${data.gameInfo.ImageIcon}" 
                                 alt="${data.gameInfo.Title}" 
                                 class="ra-box-art"
                                 onerror="this.src='https://retroachievements.org/Images/017657.png'">
                            <h2 class="ra-game-title">${data.gameInfo.Title}</h2>
                        </a>
                    </div>
                    <div class="ra-challenge-info">
                        This challenge runs from December 1st, 2024 to December 31st, 2024 as part of the gaming community Select Start. 
                        All players must have hardcore mode turned on for RetroAchievements. Any discrepancies, ties, or edge case situations 
                        will be judged case by case and settled upon in the multiplayer game of each combatant's choosing.
                    </div>
                `;

                // Keep existing leaderboard generation
                data.leaderboard.forEach((user, index) => {
                    html += `
                        <div class="ra-leaderboard-item">
                            <span class="ra-rank">#${index + 1}</span>
                            <span class="ra-medal">${getMedal(index)}</span>
                            <img src="${user.profileImage}" 
                                 alt="${user.username}" 
                                 class="ra-profile-img"
                                 onerror="this.src='https://retroachievements.org/UserPic/_user.png'">
                            <div class="ra-user-info">
                                <div class="ra-username">
                                    <a href="${user.profileUrl}" target="_blank">${user.username}</a>
                                </div>
                                <div class="ra-progress">
                                    <div class="ra-progress-bar" style="width: ${user.completionPercentage}%"></div>
                                </div>
                            </div>
                            <div class="ra-completion">
                                ${user.completedAchievements}/${user.totalAchievements}
                                <br>
                                ${user.completionPercentage}%
                            </div>
                        </div>
                    `;
                });

                // Add additional participants if any
                if (data.additionalParticipants && data.additionalParticipants.length > 0) {
                    html += `
                        <div class="ra-additional-participants">
                            Additional participants: ${data.additionalParticipants.join(', ')}
                        </div>
                    `;
                }

                html += `
                    <div class="ra-update-time">
                        Last updated: ${formatDate(data.lastUpdated)}
                    </div>
                `;
                
                document.getElementById('leaderboard').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('leaderboard').innerHTML = `
                    <div class="ra-error">
                        Error loading leaderboard: ${error.message}
                        <br><br>
                        <button onclick="retryUpdate()" class="ra-retry-button">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function retryUpdate() {
            updateLeaderboardWithTimeout();
        }

        // Initial update
        updateLeaderboardWithTimeout();

        // Update every 5 minutes
        updateTimer = setInterval(updateLeaderboardWithTimeout, 300000);
    </script>
</body>
</html>
