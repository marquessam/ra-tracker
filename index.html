<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .ra-widget {
            background: #17254A;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
        }

        .ra-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .ra-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .ra-header-text {
            margin-left: 20px;
            flex-grow: 1;
        }

        .ra-challenge-title {
            color: white;
            font-size: 1.8em;
            margin: 0 0 15px 0;
        }

        .ra-game-info {
            text-align: center;
            padding: 20px 0;
            border-top: 2px solid #2a3a6a;
            border-bottom: 2px solid #2a3a6a;
        }

        .ra-game-link {
            color: inherit;
            text-decoration: none;
            display: inline-block;
            transition: opacity 0.2s;
        }

        .ra-game-link:hover {
            opacity: 0.8;
        }

        .ra-box-art {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }

        .ra-game-title {
            color: white;
            margin: 10px 0;
            font-size: 1.5em;
        }

        .ra-challenge-info {
            background: #2a3a6a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .ra-leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 8px 0;
            background: #2a3a6a;
            border-radius: 4px;
            transition: transform 0.2s;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ra-leaderboard-item:hover {
            transform: translateX(5px);
        }

        .ra-rank {
            font-size: 1.2em;
            font-weight: bold;
            width: 40px;
            color: white;
        }

        .ra-medal {
            font-size: 1.4em;
            width: 40px;
        }

        .ra-profile-img {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            margin-right: 15px;
            border: 2px solid #5c3391;
        }

        .ra-user-info {
            flex: 1;
            min-width: 200px;
        }

        .ra-username {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .ra-username a {
            color: white;
            text-decoration: none;
            transition: color 0.2s;
        }

        .ra-username a:hover {
            color: #5c3391;
        }

        .ra-progress {
            background: #17254A;
            border-radius: 4px;
            height: 10px;
            margin-top: 5px;
            width: 100%;
            max-width: 300px;
        }

        .ra-progress-bar {
            background: #5c3391;
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }

        .ra-completion {
            margin-left: 15px;
            font-size: 0.9em;
            min-width: 120px;
            text-align: right;
        }

        .ra-additional-participants {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #2a3a6a;
            color: #666;
            font-size: 0.9em;
        }

        .ra-update-time {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8em;
            color: #666;
        }

        .ra-loading {
            text-align: center;
            padding: 40px;
            background: #2a3a6a;
            border-radius: 8px;
            margin: 20px 0;
        }

        .ra-loading-spinner {
            border: 4px solid #17254A;
            border-top: 4px solid #5c3391;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .ra-error {
            background: #2a3a6a;
            color: #ff6b6b;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .ra-retry-button {
            background: #5c3391;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .ra-retry-button:hover {
            background: #4a2a75;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .ra-widget {
                padding: 10px;
            }

            .ra-header {
                justify-content: center;
                text-align: center;
            }

            .ra-header-text {
                width: 100%;
                text-align: center;
                margin-top: 10px;
                margin-left: 0;
            }

            .ra-challenge-title {
                font-size: 1.5em;
                margin: 5px 0;
            }

            .ra-challenge-info {
                font-size: 0.85em;
                padding: 15px;
            }

            .ra-box-art {
                width: 80px;
                height: 80px;
                margin-right: 0;
            }

            .ra-game-title {
                font-size: 1.2em;
            }

            .ra-leaderboard-item {
                padding: 8px;
            }

            .ra-rank {
                width: 30px;
                font-size: 1em;
            }

            .ra-medal {
                width: 30px;
                font-size: 1.2em;
            }

            .ra-profile-img {
                width: 40px;
                height: 40px;
            }

            .ra-username {
                font-size: 1em;
            }

            .ra-progress {
                max-width: 100%;
            }

            .ra-completion {
                font-size: 0.8em;
                width: 100%;
                text-align: center;
                margin: 5px 0 0 0;
            }

            .ra-additional-participants {
                font-size: 0.8em;
                padding: 10px;
            }
        }

        @media (max-width: 380px) {
            .ra-challenge-title {
                font-size: 1.3em;
            }

            .ra-user-info {
                min-width: 150px;
            }

            .ra-username {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="ra-widget">
        <div id="leaderboard"></div>
    </div>

    <script>
        const GAME_ID = '319';
        const TIMEOUT_DURATION = 30000;
        let updateTimer = null;

        function getMedal(position) {
            switch(position) {
                case 0: return 'ðŸ¥‡';
                case 1: return 'ðŸ¥ˆ';
                case 2: return 'ðŸ¥‰';
                default: return '';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        async function updateLeaderboardWithTimeout() {
            const timeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timed out')), TIMEOUT_DURATION)
            );

            try {
                document.getElementById('leaderboard').innerHTML = `
                    <div class="ra-loading">
                        <div class="ra-loading-spinner"></div>
                        <div>Loading leaderboard data...</div>
                        <div style="font-size: 0.8em; margin-top: 10px; color: #888;">
                            This may take a few moments as we fetch data for all players
                        </div>
                    </div>
                `;

                const fetchPromise = fetch(`/api/game-progress?gameId=${GAME_ID}`);
                const response = await Promise.race([fetchPromise, timeout]);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                // Filter out users with no progress
                const activeUsers = data.leaderboard.filter(user => 
                    user.completedAchievements > 0 && user.completionPercentage > 0
                );
                
                let html = `
                    <div class="ra-header">
                        <img src="https://i.ibb.co/TgK5Hx9/select-start-logo-4.png" alt="Select Start" class="ra-logo">
                        <div class="ra-header-text">
                            <div class="ra-challenge-title">January Leaderboards</div>
                        </div>
                    </div>
                    <div class="ra-game-info">
                        <a href="https://retroachievements.org/game/${GAME_ID}" class="ra-game-link" target="_blank">
                            <img src="https://retroachievements.org${data.gameInfo.ImageIcon}" 
                                 alt="${data.gameInfo.Title}" 
                                 class="ra-box-art"
                                 onerror="this.src='https://retroachievements.org/Images/017657.png'">
                            <h2 class="ra-game-title">${data.gameInfo.Title}</h2>
                        </a>
                    </div>
                    <div class="ra-challenge-info">
                        This challenge runs from January 1st, 2024 to January 31st, 2025 as part of the gaming community Select Start. 
                        All players must have hardcore mode turned on for RetroAchievements. Any discrepancies, ties, or edge case situations 
                        will be judged case by case and settled upon in the multiplayer game of each combatant's choosing.
                    </div>
                `;

                activeUsers.forEach((user, index) => {
                    html += `
                        <div class="ra-leaderboard-item">
                            <span class="ra-rank">#${index + 1}</span>
                            <span class="ra-medal">${getMedal(index)}</span>
                            <img src="${user.profileImage}" 
                                 alt="${user.username}" 
                                 class="ra-profile-img"
                                 onerror="this.src='https://retroachievements.org/UserPic/_user.png'">
                            <div class="ra-user-info">
                                <div class="ra-username">
                                    <a href="${user.profileUrl}" target="_blank">${user.username}</a>
                                </div>
                                <div class="ra-progress">
                                    <div class="ra-progress-bar" style="width: ${user.completionPercentage}%"></div>
                                </div>
                            </div>
                            <div class="ra-completion">
                                ${user.completedAchievements}/${user.totalAchievements}
                                <br>
                                ${user.completionPercentage}%
                            </div>
                        </div>
                    `;
                });

                // Filter additional participants
                const activeParticipants = data.additionalParticipants.filter(username => {
                    const userInLeaderboard = data.leaderboard.find(u => u.username === username);
                    return userInLeaderboard && userInLeaderboard.completedAchievements > 0;
                });

                if (activeParticipants.length > 0) {
                    html += `
                        <div class="ra-additional-participants">
                            Additional participants: ${activeParticipants.join(', ')}
                        </div>
                    `;
                }

                html += `
                    <div class="ra-update-time">
                        Last updated: ${formatDate(data.lastUpdated)}
                    </div>
                `;
                
                document.getElementById('leaderboard').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('leaderboard').innerHTML = `
                    <div class="ra-error">
                        Error loading leaderboard: ${error.message}
                        <br><br>
                        <button onclick="retryUpdate()" class="ra-retry-button">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function retryUpdate() {
            updateLeaderboardWithTimeout();
        }

        // Initial update
        updateLeaderboardWithTimeout();

        // Update every 5 minutes
        updateTimer = setInterval(updateLeaderboardWithTimeout, 300000);

        // Function to send height to parent
        function updateParentHeight() {
            const height = document.body.scrollHeight;
            window.parent.postMessage({ type: 'resize', height: height }, '*');
        }

        // Send height after initial load and any updates
        window.addEventListener('load', updateParentHeight);
        // Also update periodically in case content changes
        setInterval(updateParentHeight, 1000);
    </script>
</body>
</html>
